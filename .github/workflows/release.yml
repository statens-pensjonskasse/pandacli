name: release

on:
  workflow_dispatch:
  push:
    branches: ["main"]

permissions:
  contents: write
  pull-requests: write

jobs:
  propose_release_pr:
    name: Lag release PR (ingen direkte push til main)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sett opp Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Bestemme hvilken versjon som skal bumpes (Conventional Commits, skip release commits)
        id: bump
        shell: bash
        run: |
          set -euo pipefail

          LAST_TAG="$(git describe --tags --abbrev=0 2>/dev/null || true)"

          HEAD_SUBJECT="$(git log -1 --pretty=format:%s)"
          if echo "$HEAD_SUBJECT" | grep -qE '^chore\(release\):'; then
            echo "should_release=false" >> "$GITHUB_OUTPUT"
            echo "bump=none" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ -n "$LAST_TAG" ]; then
            RANGE="${LAST_TAG}..HEAD"
            SUBJECTS="$(git log $RANGE --pretty=format:%s | grep -vE '^chore\(release\):' || true)"
            LOG="$(git log $RANGE --pretty=format:'%s%n%b%n----END----')"
          else
            SUBJECTS="$(git log --pretty=format:%s | grep -vE '^chore\(release\):' || true)"
            LOG="$(git log --pretty=format:'%s%n%b%n----END----')"
          fi

          if [ -z "$SUBJECTS" ]; then
            echo "should_release=false" >> "$GITHUB_OUTPUT"
            echo "bump=none" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          BUMP="none"
          if echo "$SUBJECTS" | grep -qE '^feat(\(.+\))?!:'; then
            BUMP="major"
          elif echo "$LOG" | grep -qE 'BREAKING CHANGE'; then
            BUMP="major"
          elif echo "$SUBJECTS" | grep -qE '^feat(\(.+\))?:'; then
            BUMP="minor"
          elif echo "$SUBJECTS" | grep -qE '^(fix|perf)(\(.+\))?:'; then
            BUMP="patch"
          fi

          if [ "$BUMP" = "none" ]; then
            echo "should_release=false" >> "$GITHUB_OUTPUT"
          else
            echo "should_release=true" >> "$GITHUB_OUTPUT"
          fi

          echo "bump=$BUMP" >> "$GITHUB_OUTPUT"

      - name: Bump versjon i Cargo.toml
        if: steps.bump.outputs.should_release == 'true'
        shell: bash
        run: |
          set -euo pipefail
          cargo install cargo-edit --locked
          cargo set-version --bump "${{ steps.bump.outputs.bump }}"

      - name: Les version
        if: steps.bump.outputs.should_release == 'true'
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          VERSION="$(cargo pkgid | sed 's/.*#//')"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Lag eller oppdater release PR
        if: steps.bump.outputs.should_release == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          branch: chore/release-v${{ steps.ver.outputs.version }}
          title: "chore(release): v${{ steps.ver.outputs.version }}"
          commit-message: "chore(release): v${{ steps.ver.outputs.version }}"
          body: |
            Automated release PR for v${{ steps.ver.outputs.version }}.
            Merge this PR to trigger tagging + GitHub Release + binaries upload.
          labels: release
          delete-branch: true
