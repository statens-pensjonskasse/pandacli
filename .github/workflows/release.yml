name: release

on:
  workflow_dispatch:
  push:
    branches: ["main"]

permissions:
  contents: write
  pull-requests: write

jobs:
  propose_release_pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sett opp Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      # (Your bump detection step goes here: sets should_release + bump)
      # id: bump

      - name: Lag release branch lokalt
        if: steps.bump.outputs.should_release == 'true'
        shell: bash
        run: |
          set -euo pipefail
          # compute version after bump later, but branch name can be temporary first
          BRANCH="chore/release"
          git switch -c "$BRANCH"
          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"

      - name: Bump versjon filer
        if: steps.bump.outputs.should_release == 'true'
        shell: bash
        run: |
          set -euo pipefail
          cargo install cargo-edit --locked
          cargo set-version --bump "${{ steps.bump.outputs.bump }}"

      - name: Les version og sett endelig branch name
        if: steps.bump.outputs.should_release == 'true'
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          VERSION="$(cargo pkgid | sed 's/.*#//')"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "RELEASE_BRANCH=chore/release-v$VERSION" >> "$GITHUB_ENV"
          git branch -m "$BRANCH" "chore/release-v$VERSION"

      - name: Lag signed release commit (and push)
        if: steps.bump.outputs.should_release == 'true'
        id: signed_commit
        uses: statens-pensjonskasse/gha-create-signed-commit@COMMIT_SHA
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.RELEASE_BRANCH }}
          message: "chore(release): v${{ steps.ver.outputs.version }}"
          # limit what goes into the commit (recommended)
          paths: |
            Cargo.toml
            Cargo.lock
          push: true

      - name: Lag eller oppdater PR
        if: steps.bump.outputs.should_release == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          # Create PR if it doesn't exist; otherwise update is automatic since branch is pushed
          if gh pr view "$RELEASE_BRANCH" >/dev/null 2>&1; then
            echo "PR already exists for $RELEASE_BRANCH"
          else
            gh pr create \
              --head "$RELEASE_BRANCH" \
              --base "main" \
              --title "chore(release): v${{ steps.ver.outputs.version }}" \
              --body "Automated release PR for v${{ steps.ver.outputs.version }}."
          fi
